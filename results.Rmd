---
title: "Gaming during COVID-19"
author: "Matti"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(anytime)
library(lubridate)
library(broom)
library(scales)
library(patchwork)
library(mgcv)
library(dygraphs)
library(glue)
library(kableExtra)
library(fst)
opts_chunk$set(
  cache = TRUE, 
  echo = FALSE, 
  warning = FALSE,
  message = FALSE
)
theme_set(
  theme_linedraw() + theme(panel.grid = element_blank())
)
```

# Introduction

We used data from Steam to investigate changes in patterns of gaming during the COVID-19 emergency. The dataset contained the daily number of players on the Steam platform for 40009 titles from 2000 to April 12, 2020. We focused on changes related to the COVID emergency in 2020, and for this purpose used only data from January 1st 2019 to April 12, 2020. These data are shown in Figure \@ref(fig:gam-fig).

Our main questions related to changes in engagement during the COVID-19 pandemic. However, the Steam data is at a global level, and thus cannot be linked to local information, such as lockdown orders. Therefore, we sought to identify the most general (global) temporal indicator of the COVID-19 pandemic. To this purpose, we used 12 March 2020---the date when WHO declared COVID-19 a global pandemic[^fn1]---as the critical date. In our analyses below, that date is used to divide dates into COVID and non-COVID periods.

[^fn1]: <https://www.who.int/news-room/detail/27-04-2020-who-timeline---covid-19>, <http://www.euro.who.int/en/health-topics/health-emergencies/coronavirus-covid-19/news/news/2020/3/who-announces-covid-19-outbreak-a-pandemic>

# Results

```{r data-processing}
steam <- read_fst("data/steam.fst") %>% as_tibble()

# We first analyze total volume in 2019-2020
dat <- tibble(
  date = names(select(steam, `2019-01-01`:`2020-04-12`)),
  players = colSums(select(steam, `2019-01-01`:`2020-04-12`), na.rm = TRUE)
) %>% 
  mutate(date = anydate(date))

# Add useful time indicators
dat <- dat %>% 
  arrange(date) %>% 
  mutate(
    day = 1:n() - 1,  # nth day in total data
    week = day %/% 7,  # nth week in total data
    year = factor(year(date)),
    ymonth = factor(month(date, label = T), ordered = FALSE),
    yweek = isoweek(date),  # Warning, weeks are weird
    wday = factor(wday(date, week_start = 1, label = T), ordered = F), 
    yday = yday(date) - 1,
    wend = factor(as.numeric(wday %in% c("Sat", "Sun"))),
    # COVID
    covid = factor(
      date >= anydate("2020-03-12") & date <= anydate("2020-04-12"), 
      labels = 0:1
    ),
    # Control period in 2019
    control = factor(
      date >= anydate("2019-03-12") & date <= anydate("2019-04-12"), 
      labels = 0:1
    ),
    # COVID or control
    test = factor(covid==1 | control == 1, labels = 0:1)
  )
# psst: get holidays with
# prophet::generated_holidays
```

```{r total-volume, fig.cap = "Total volume on Steam", eval = FALSE}
dat %>%   
  ggplot(aes(date, players)) +
  geom_rect(
    aes(xmin=anydate("2020-03-12"), xmax = anydate("2020-04-20"),
        ymin = -Inf, ymax = Inf),
    col = NA, fill = "gray80"
  ) +
  scale_x_date(
    "Date", 
    date_breaks = "3 month",
    expand = expansion(.01)
  ) +
  coord_cartesian(xlim = c(anydate("2019-01-01"), anydate("2020-04-12"))) +
  scale_y_continuous(
    "Players", 
    labels = scales::label_number(big.mark = ",")
  ) +
  geom_line()
```

```{r volume-interactive, eval = FALSE}
library(highcharter)
dat %>% 
  rename(Players = players, Date = date) %>% 
  hchart(
    type = "line", 
    hcaes(x=Date, y=Players), 
    name = "Players", 
    lineWidth = 1,
    color = "dodgerblue"
  ) %>% 
  hc_add_theme(hc_theme_flat()) %>% 
  hc_yAxis(labels = list(format = "{value}"))
```

## Changes in total engagement

Our main questions concerned the daily total number of players on Steam.

1. To what extent did Steam engagement change during the COVID-19 pandemic?
2. To what extent did the gap between weekend and weekday engagement change during the COVID pandemic? 

```{r, results = 'hide'}
# Total change
dat %>% 
  group_by(year, test) %>% 
  summarise(players = round(mean(players), 2)) %>% 
  pivot_wider(names_from = test, values_from = c(players)) %>% 
  mutate(increase = `1`-`0`, ratio = `1`/`0`)
# Weekend effect change
dat %>% 
  group_by(year, test, wend) %>% 
  summarise(players = round(mean(players), 2)) %>% 
  pivot_wider(names_from = wend, values_from = c(players)) %>% 
  mutate(w_increase = `1`-`0`, w_ratio = `1`/`0`)
```

The mean steam engagement in 2020 leading up to March 12 was 4.68 million, whereas during COVID it reached 5.82 million, a change of +24%. In 2020 before COVID, weekend days saw 16% more players than weekdays (4.48 vs 5.20m), but during COVID, this weekend effect was 10%. The change in engagement in the corresponding period in 2019 (March 12 to April 12 2019 vs before) was only +5%, and the weekend effect was increased by 1% in that period in 2019. Thus, COVID seemed to increase total Steam engagement, and to reduce the gap between weekend and weekday engagement, and those effects were specific to COVID---and not, say, the difference between February and March---as suggested by the comparable analyses done with 2019's data.

To analyze the timeseries of Steam engagement in more detail, and any potential COVID-related changes to it, we specified a generalized additive model (GAM) of daily Steam engagement between January 1st 2019 to April 12th 2020. The model predicted engagement from indicator variables for year, weekend, COVID, and interactions between COVID & weekend, and year & weekend as fixed predictors. We used thin plate regression splines and an AR1 autocorrelation term to account for the temporal features in the data. The model's implied Steam timeseries is displayed in blue in Figure \@ref(fig:gam-fig).

```{r gam, results = "hide"}
tmp <- dat %>% 
  mutate(year = relevel(year, ref = "2020")) %>% 
  mutate(wday = relevel(wday, ref = "Wed"))
fit1 <- gamm(
  players ~ wend*covid + year*wend + s(day, k = 40),
  # random = list(week = ~ 1),
  correlation = corAR1(form = ~ day | covid),
  data = tmp
)
summary(fit1$gam)
fx <- tidy(fit1$gam, parametric = TRUE, conf.int = TRUE) %>% 
  select(-statistic)
# gam.check(fit1$gam)  # ...ok
# acf(residuals(fit1$gam))  # ...hmmmm :/
# Compare weekly smooths between COVID and non-covid
# fit2 <- gamm(
#   players ~ covid + 
#     s(yday, by = year, k = 40) + 
#     s(as.numeric(wday), by = covid, k = 4),
#   # random = list(week = ~ 1),
#   correlation = corAR1(form = ~ day),
#   data = tmp
# )
# fit3 <- gamm(
#   players ~ covid + 
#     s(yday, by = year, k = 40) + 
#     s(as.numeric(wday), k = 4),
#   # random = list(week = ~ 1),
#   correlation = corAR1(form = ~ day),
#   data = tmp
# )
# anova(fit2$lme, fit3$lme)
```

```{r results-fig, eval = FALSE}
tmp %>% 
  mutate(
    .fit = predict(fit1$gam),
    .se = predict(fit1$gam, se.fit = TRUE)$se.fit,
  ) %>% 
  ggplot(aes(date, players)) +
  geom_vline(aes(xintercept = anydate("2020-03-12")), size = .2) +
  # geom_line(aes(y=.fit2), col = "red") +
  geom_line(aes(y=.fit), size = .33) +
  geom_ribbon(aes(ymin=.fit-.se*1.96, ymax=.fit+.se*1.96), alpha = .2) +
  geom_point(shape=21, fill = "white")
```

```{r gam-fig, fig.cap = "Steam engagement (green dots) and GAM fitted mean engagement (blue line and 95%CI as shade)."}
x <- tmp %>% 
  mutate(
    .se = predict(fit1$gam, se.fit = TRUE)$se.fit,
    Players = players,
    Fitted = predict(fit1$gam),
    Lower = Fitted - .se*1.96,
    Upper = Fitted + .se*1.96
  )
times <- x$date
x <- select(x, Players:Upper)
x <- xts::xts(x, order.by = times)
dygraph(x, main = "Daily Steam players") %>% 
  dyShading(from = "2020-03-12", to = "2020-05-12", color = "#FFE6E6") %>% 
  dySeries("Players", drawPoints = TRUE, strokeWidth = 0, pointSize = 3) %>%
  dySeries(c("Lower", "Fitted", "Upper"), label = "GAM") %>%
  dyLegend(show = "follow") %>% 
  dyEvent(
    "2020-03-12", "WHO announcement", labelLoc = "bottom"
  ) %>% 
  dyRangeSelector()
```

The model explained `r scales::percent(summary(fit1$gam)$r.sq)` of variance in engagement, and suggested important COVID-19 related changes in engagement. The model's linear parameters are described in Table \@ref(tab:results-tab). The constant described engagement in 2020 before COVID-19, and was close to the empirical mean, although slightly lower due to the model's smooth and autocorrelation terms. During that period, the weekend effect's magnitude (conditional on the model) was 636k. Importantly, the model described a 581k increase in engagement following the WHO announcement. Overall, the weekend effect was smaller during COVID, compared to 2020 leading up to the WHO announcement, but the credibility interval included zero, indicating considerable uncertainty in the effect. 

However, it is important to keep in mind that there are only 5 weekends in the COVID era in the Steam dataset, as its last date is April 12. Therefore, there is considerable uncertainty in the parameters regarding COVID-related changes. Further, a large outlier on March 4th suggested either considering more robust likelihood functions (e.g. Student's *t*), or including additional information about the platform (e.g. significant game releases) to the model. Another source of uncertainty is the temporal resolution of the data: The dates presumably indicate the date at a Steam server, and thus that day (e.g Friday in California) may differ from a player's local day (e.g. Saturday in Australia), making it more difficult to e.g. study the weekend effect. Future work should address these issues.

```{r results-tab}
fx %>% 
  mutate(term = c("2020 (pre-COVID)", "Weekend", "Covid", "2019", "Wknd x COVID", "Wknd x 2019")) %>% 
  kable(digits = c(0,0,0,3,0,0), caption = "GAM linear parameters") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

```{r prophet, eval = FALSE, message = FALSE}
library(prophet)
holidays <- data.frame(
  holiday = "covid",
  ds = as.Date("2020-03-12 GMT"),
  lower_window = 0,
  upper_window = 60
)
tmp <- rename(dat, ds=date, y=players)
m <- prophet(
  tmp, 
  daily.seasonality = FALSE, 
  yearly.seasonality = TRUE, 
  weekly.seasonality = TRUE,
  # holidays = holidays,
  # changepoints = as.Date("2020-03-12 GMT"),
  n.changepoints = 1,
  fit = FALSE
)
# m <- add_country_holidays(m, "US")
m <- fit.prophet(m, tmp)
future <- make_future_dataframe(m, periods = 7*2)
forecast <- predict(m, future)
# plot(m, forecast) + add_changepoints_to_plot(m, trend = FALSE)
# prophet_plot_components(m, forecast)
# dyplot.prophet(m, forecast)
# m$changepoints
```

Finally, we wanted to know whether changes in Steam engagement potentially preceded the WHO announcement on March 12th. To this end, we fit an exploratory GAM using [Prophet](https://facebook.github.io/prophet/) to detect a single changepoint in the Steam timeseries. This method suggested that a change in linear trends of engagement may have occurred as early as January 9th, 2020.

```{r, eval = FALSE}
# Leftover bits and pieces below
dat %>% 
  ggplot(aes(wday, players, col = test)) +
  geom_line(aes(group = week)) +
  facet_wrap("year")
```

```{r}
# "Excess gaming" graph: Compare 2020 to previous 10 years
tmp <- top_n(steam, 9, positive)
tmp <- tmp %>% 
  pivot_longer(
    `2010-01-01`:`2020-04-12`, 
    names_to = "date", 
    values_to = "players"
    )
tmp <- tmp %>% 
  mutate(
    year = factor(year(date)), 
    year2020 = factor(year(date) == 2020), 
    yday = yday(date)
  ) 
tmp2 <- tmp %>% 
  group_by(date) %>% 
  summarise(players = mean(players, na.rm = TRUE)) %>% 
  mutate(
    title = ".Mean",
    year = factor(year(date)), 
    year2020 = factor(year(date) == 2020), 
    yday = yday(date)
  )
tmp %>%   
  ggplot(aes(yday, players, col = year2020, group = year)) +
  geom_line() +
  geom_line(data = tmp2) +
  facet_wrap("title", scales = "free_y", ncol = 2)
```


```{r, eval = FALSE}
# Summaries of genres and features
x <- select(steam, title, contains("genre"), contains("features")) %>% 
  pivot_longer(-title) %>% 
  separate(name, c("name", "what"), extra = "merge")
x %>% 
  filter(name == "features") %>% 
  group_by(name, what) %>% 
  summarise(n_titles = sum(value)) %>% 
  mutate(what = reorder(what, n_titles)) %>% 
  ggplot(aes(n_titles, what)) +
  geom_point() +
  facet_wrap("name", scales = "free")

x %>% 
  filter(name == "genre") %>% 
  mutate(what = str_remove(what, "\\.y")) %>% 
  group_by(name, what) %>% 
  summarise(n_titles = sum(value)) %>% 
  mutate(what = reorder(what, n_titles)) %>% 
  ggplot(aes(n_titles, what)) +
  geom_point() +
  facet_wrap("name", scales = "free")
```
